<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Profile - AgriGorithm</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" href="/public/favicon.ico" type="image/x-icon">
</head>
<body class="bg-background min-h-screen">
    <!-- Header -->
    <header class="bg-surface-raised border-b border-border sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Back Navigation -->
                <div class="flex items-center space-x-4">
                    <a href="home_screen.html" class="flex items-center text-text-secondary hover:text-primary transition-colors duration-200" aria-label="Go to home">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Back to Home
                    </a>
                </div>

                <!-- Logo -->
                <div class="flex-1 flex justify-center">
                    <a href="home_screen.html" class="flex items-center">
                        <svg class="w-8 h-8 text-primary mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        <span class="text-xl font-bold text-text-primary">AgriGorithm</span>
                    </a>
                </div>

                <!-- Cart Icon -->
                <div class="flex items-center">
                    <button class="relative p-2 text-text-secondary hover:text-primary transition-colors duration-200" aria-label="Shopping cart">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 11-4 0v-6m4 0V9a2 2 0 10-4 0v4.01"></path>
                        </svg>
                        <span id="cart-count" class="absolute -top-1 -right-1 bg-primary text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto px-4 py-8">
        <!-- Login Form -->
        <div id="login-section" class="space-y-6">
            <div class="text-center space-y-2">
                <h1 class="text-3xl font-bold text-text-primary">Welcome Back</h1>
                <p class="text-text-secondary">Sign in to your account to continue</p>
            </div>

            <!-- Login Form Card -->
            <div class="bg-surface-raised rounded-lg border border-border p-6 shadow-sm">
                <form id="login-form" class="space-y-4">
                    <!-- Email Field -->
                    <div class="space-y-2">
                        <label for="login-email" class="block text-sm font-medium text-text-primary">Email Address</label>
                        <input 
                            type="email" 
                            id="login-email" 
                            name="email" 
                            class="input-field" 
                            placeholder="Enter your email"
                            required
                            autocomplete="email"
                        >
                        <div id="email-error" class="hidden text-sm text-error flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span>Please enter a valid email address</span>
                        </div>
                    </div>

                    <!-- Password Field -->
                    <div class="space-y-2">
                        <label for="login-password" class="block text-sm font-medium text-text-primary">Password</label>
                        <div class="relative">
                            <input 
                                type="password" 
                                id="login-password" 
                                name="password" 
                                class="input-field pr-10" 
                                placeholder="Enter your password"
                                required
                                autocomplete="current-password"
                            >
                            <button 
                                type="button" 
                                id="toggle-password" 
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-text-tertiary hover:text-text-secondary transition-colors duration-200"
                                aria-label="Toggle password visibility"
                            >
                                <svg id="eye-open" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                <svg id="eye-closed" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="password-error" class="hidden text-sm text-error flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span>Password must be at least 6 characters long</span>
                        </div>
                    </div>

                    <!-- Login Button -->
                    <button 
                        type="submit" 
                        id="login-btn" 
                        class="w-full bg-primary text-white py-3 px-6 rounded-lg font-semibold hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-all duration-300 transform hover:scale-105"
                    >
                        <span id="login-btn-text">Sign In</span>
                        <svg id="login-loading" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>

                    <!-- Error Message -->
                    <div id="login-error" class="hidden bg-error bg-opacity-10 border border-error border-opacity-20 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5 text-error" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span id="login-error-text" class="text-sm text-error">Invalid email or password. Please try again.</span>
                        </div>
                    </div>
                </form>

                <!-- Registration Link -->
                <div class="mt-6 text-center">
                    <p class="text-text-secondary">
                        Don't have an account? 
                        <button id="show-register" class="text-primary hover:text-primary-dark font-medium transition-colors duration-200">
                            Create one here
                        </button>
                    </p>
                </div>
            </div>
        </div>


        <!-- Register Form -->
        <div id="register-section" class="hidden space-y-6">
            <div class="text-center space-y-2">
                <h1 class="text-3xl font-bold text-text-primary">Create Account</h1>
                <p class="text-text-secondary">Join us and start farming smarter</p>
            </div>

            <!-- Register Form Card -->
            <div class="bg-surface-raised rounded-lg border border-border p-6 shadow-sm">
                <form id="register-form" class="space-y-4">
                    <!-- Name Field -->
                    <div class="space-y-2">
                        <label for="register-name" class="block text-sm font-medium text-text-primary">Full Name</label>
                        <input type="text" id="register-name" name="name" class="input-field" placeholder="John Smith" required>
                    </div>

                    <!-- Email Field -->
                    <div class="space-y-2">
                        <label for="register-email" class="block text-sm font-medium text-text-primary">Email</label>
                        <input type="email" id="register-email" name="email" class="input-field" placeholder="you@example.com" required>
                    </div>

                    <!-- Password Field -->
                    <div class="space-y-2">
                        <label for="register-password" class="block text-sm font-medium text-text-primary">Password</label>
                        <input type="password" id="register-password" name="password" class="input-field" placeholder="••••••••" required>
                    </div>

                    <!-- City Field -->
                    <div class="space-y-2">
                        <label for="register-city" class="block text-sm font-medium text-text-primary">City</label>
                        <input type="text" id="register-city" name="city" class="input-field" placeholder="Sacramento">
                    </div>

                    <!-- Province Field -->
                    <div class="space-y-2">
                        <label for="register-province" class="block text-sm font-medium text-text-primary">Province</label>
                        <input type="text" id="register-province" name="province" class="input-field" placeholder="California">
                    </div>

                    <!-- Region Field -->
                    <div class="space-y-2">
                        <label for="register-region" class="block text-sm font-medium text-text-primary">Region</label>
                        <input type="text" id="register-region" name="region" class="input-field" placeholder="West Coast">
                    </div>

                    <!-- Register Button -->
                    <button type="submit" id="register-btn" class="w-full bg-primary text-white py-3 px-6 rounded-lg font-semibold hover:bg-primary-dark transition duration-300 transform hover:scale-105">
                        Register
                    </button>
                </form>

                <!-- Back to Login -->
                <div class="mt-6 text-center">
                    <p class="text-text-secondary">
                        Already have an account?
                        <button id="back-to-login" class="text-primary hover:text-primary-dark font-medium transition-colors duration-200">
                            Sign in here
                        </button>
                    </p>
                </div>
            </div>
        </div>



        <!-- Profile Section -->
        <div id="profile-section" class="hidden space-y-6">
            <div class="text-center space-y-2">
                <h1 class="text-3xl font-bold text-text-primary">My Profile</h1>
                <p class="text-text-secondary">Manage your account information</p>
            </div>

            <!-- Profile View -->
            <div id="profile-view" class="bg-surface-raised rounded-lg border border-border p-6 shadow-sm">
                <!-- <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-text-primary">Profile Information</h2>
                    <button id="edit-profile-btn" class="btn-outline">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Edit Profile
                    </button>
                </div> -->

                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-text-primary">Profile Information</h2>
                    <div class="flex gap-2">
                        <button id="view-products-btn" class="btn-outline">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v16a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm16 4H5v10h14V8z" />
                        </svg>
                        View Products
                        </button>

                        <button id="edit-profile-btn" class="btn-outline">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Edit Profile
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Full Name</label>
                            <p id="profile-name" class="text-text-primary font-medium"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Email Address</label>
                            <p id="profile-email" class="text-text-primary font-medium"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Contact Number</label>
                            <p id="profile-contact" class="text-text-primary font-medium"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">City</label>
                            <p id="profile-city" class="text-text-primary font-medium"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Province/State</label>
                            <p id="profile-province" class="text-text-primary font-medium"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Region</label>
                            <p id="profile-region" class="text-text-primary font-medium"></p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-border">
                    <button id="logout-btn" class="w-full bg-error text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-error focus:ring-offset-2 transition-all duration-300">
                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        Sign Out
                    </button>
                </div>
            </div>

            <!-- Profile Edit Form -->
            <div id="profile-edit" class="hidden bg-surface-raised rounded-lg border border-border p-6 shadow-sm">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-text-primary">Edit Profile</h2>
                    <button id="cancel-edit-btn" class="text-text-secondary hover:text-text-primary transition-colors duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="profile-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-name" class="block text-sm font-medium text-text-primary mb-1">Full Name</label>
                            <input type="text" id="edit-name" name="name" class="input-field" required>
                        </div>
                        <div>
                            <label for="edit-email" class="block text-sm font-medium text-text-primary mb-1">Email Address</label>
                            <input type="email" id="edit-email" name="email" class="input-field" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-contact" class="block text-sm font-medium text-text-primary mb-1">Contact Number</label>
                            <input type="tel" id="edit-contact" name="contact" class="input-field" required>
                        </div>
                        <div>
                            <label for="edit-city" class="block text-sm font-medium text-text-primary mb-1">City</label>
                            <input type="text" id="edit-city" name="city" class="input-field" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-province" class="block text-sm font-medium text-text-primary mb-1">Province/State</label>
                            <input type="text" id="edit-province" name="province" class="input-field" required>
                        </div>
                        <div>
                            <label for="edit-region" class="block text-sm font-medium text-text-primary mb-1">Region</label>
                            <input type="text" id="edit-region" name="region" class="input-field" required>
                        </div>
                    </div>

                    <div class="flex space-x-4 pt-4">
                        <button type="submit" id="save-profile-btn" class="flex-1 bg-primary text-white py-3 px-6 rounded-lg font-semibold hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-all duration-300">
                            <span id="save-btn-text">Save Changes</span>
                            <svg id="save-loading" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                        <button type="button" id="cancel-edit-btn-2" class="flex-1 btn-secondary">Cancel</button>
                    </div>

                    <!-- Save Error Message -->
                    <div id="save-error" class="hidden bg-error bg-opacity-10 border border-error border-opacity-20 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5 text-error" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span id="save-error-text" class="text-sm text-error">Failed to save changes. Please try again.</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Success Toast -->
    <div id="success-toast" class="fixed top-4 right-4 bg-success text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            <span id="toast-message">Profile updated successfully!</span>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-surface-raised border-t border-border mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="space-y-4">
                    <div class="flex items-center">
                        <svg class="w-8 h-8 text-primary mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        <span class="text-xl font-bold text-text-primary">AgriGorithm</span>
                    </div>
                    <p class="text-text-secondary">Connecting farmers with consumers for fresh, sustainable produce.</p>
                </div>
                
                <div>
                    <h3 class="font-semibold text-text-primary mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="home_screen.html" class="text-text-secondary hover:text-primary transition-colors duration-200">Home</a></li>
                        <li><a href="products_listing_screen.html" class="text-text-secondary hover:text-primary transition-colors duration-200">Products</a></li>
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">About</a></li>
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">Contact</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="font-semibold text-text-primary mb-4">Categories</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">Vegetables</a></li>
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">Fruits</a></li>
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">Grains</a></li>
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">Dairy</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="font-semibold text-text-primary mb-4">Support</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">Help Center</a></li>
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">Shipping Info</a></li>
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">Returns</a></li>
                        <li><a href="#" class="text-text-secondary hover:text-primary transition-colors duration-200">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-border mt-8 pt-8 text-center">
                <p class="text-text-secondary">© 2025 AgriGorithm. All Rights Reserved.</p>
            </div>
        </div>
    </footer>
    <script>
        // Check if user is logged in
        let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

        document.addEventListener('DOMContentLoaded', function() {
            const loginSection = document.getElementById('login-section');
            const profileSection = document.getElementById('profile-section');
            const loginForm = document.getElementById('login-form');
            const profileForm = document.getElementById('profile-form');
            const togglePassword = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('login-password');
            const eyeOpen = document.getElementById('eye-open');
            const eyeClosed = document.getElementById('eye-closed');
            const registerForm = document.getElementById('register-form');
            const loginError = document.getElementById('login-error');
            const viewSellerProducts = document.getElementById('view-products-btn');


            // Initialize view based on login status
            if (isLoggedIn) {
                showProfile();
            } else {
                showLogin();
            }

            document.getElementById('view-products-btn').addEventListener('click', () => {
                const userId = localStorage.getItem('userId');
                if (userId) {
                    window.location.href = `home_screen.html`;
                } else {
                    alert('User not found');
                }
            });


            // Password visibility toggle
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                eyeOpen.classList.toggle('hidden');
                eyeClosed.classList.toggle('hidden');
            });

            // Login form submission
            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                fetch(`/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                })
                .then(res => {
                    if (!res.ok) throw new Error("Invalid credentials");
                    return res.json();
                })
                .then(user => {

                    console.log('User object:', user); 


                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userId', user.userId);
                    showProfile();
                    showToast('Login successful! Welcome back.');
                })
                .catch(() => {
                    loginError.classList.remove('hidden');
                    document.getElementById('login-error-text').textContent = 'Invalid email or password.';
                });
            });


            // Register form submission
            registerForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const user = {
                    name: document.getElementById('register-name').value,
                    email: document.getElementById('register-email').value,
                    password: document.getElementById('register-password').value,
                    contact: document.getElementById('register-contact')?.value || '',
                    city: document.getElementById('register-city').value,
                    province: document.getElementById('register-province').value,
                    region: document.getElementById('register-region').value,
                };

                fetch(`/api/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                })
                .then(res => {
                    if (!res.ok) throw new Error("User already exists or invalid data");
                    return res.json();
                })
                .then(data => {
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userId', data.userId);
                    showToast('Account created! Welcome.');
                    setTimeout(() => {
                        window.location.href = 'login_profile_screen.html';
                    }, 1500);
                })
                .catch(err => {
                    let message = 'Unknown error';
                    if (err instanceof Error) {
                        message = err.message;
                    }
                    showToast('Registration failed: ' + message);
                });
            });


            // Profile editing
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const profileView = document.getElementById('profile-view');
            const profileEdit = document.getElementById('profile-edit');
            const cancelEditBtns = [document.getElementById('cancel-edit-btn'), document.getElementById('cancel-edit-btn-2')];

            editProfileBtn.addEventListener('click', function() {
                showEditForm();
            });

            cancelEditBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    hideEditForm();
                });
            });

            // Profile form submission
            profileForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const saveBtn = document.getElementById('save-profile-btn');
                const saveBtnText = document.getElementById('save-btn-text');
                const saveLoading = document.getElementById('save-loading');
                const saveError = document.getElementById('save-error');

                saveBtn.disabled = true;
                saveBtnText.textContent = 'Saving...';
                saveLoading.classList.remove('hidden');
                saveError.classList.add('hidden');

                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('User ID not found. Please log in again.');
                    return;
                }

                const updatedUser = {
                    userId,
                    name: document.getElementById('edit-name').value,
                    email: document.getElementById('edit-email').value,
                    contact: document.getElementById('edit-contact').value,
                    city: document.getElementById('edit-city').value,
                    province: document.getElementById('edit-province').value,
                    region: document.getElementById('edit-region').value
                };

                fetch(`/api/user/update`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedUser)
                })
                .then(res => {
                    if (!res.ok) throw new Error('Failed to update profile');
                    return res.json();
                })
                .then(data => {
                    localStorage.setItem('userData', JSON.stringify(updatedUser));

                    updateProfileDisplay();
                    hideEditForm();
                    showToast('Profile updated successfully!');
                })
                .catch(err => {
                    saveError.classList.remove('hidden');
                    document.getElementById('save-error-text').textContent = err.message || 'Failed to update profile';
                })
                .finally(() => {
                    saveBtn.disabled = false;
                    saveBtnText.textContent = 'Save Changes';
                    saveLoading.classList.add('hidden');
                });
            });



            // Logout functionality
            const logoutBtn = document.getElementById('logout-btn');
            logoutBtn.addEventListener('click', async function() {
                try {
                    // Call the server logout endpoint
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('userData');
                        isLoggedIn = false;
                        showLogin();
                        showToast('Logged out successfully!');
                        document.getElementById('login-email').value = '';
                        document.getElementById('login-password').value = '';
                    } else {
                        showToast('Logout failed. Please try again.');
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Logout failed. Please try again.');
                }
            });

            // Show register form (placeholder)
            const showRegisterBtn = document.getElementById('show-register');
            const backToLoginBtn = document.getElementById('back-to-login');
            const registerSection = document.getElementById('register-section');

            showRegisterBtn.addEventListener('click', function () {
                loginSection.classList.add('hidden');
                registerSection.classList.remove('hidden');
            });

            backToLoginBtn.addEventListener('click', function () {
                registerSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
            });


            function validateLoginForm(email, password) {
                const emailError = document.getElementById('email-error');
                const passwordError = document.getElementById('password-error');
                let isValid = true;

                // Email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    emailError.classList.remove('hidden');
                    isValid = false;
                } else {
                    emailError.classList.add('hidden');
                }

                // Password validation
                if (password.length < 6) {
                    passwordError.classList.remove('hidden');
                    isValid = false;
                } else {
                    passwordError.classList.add('hidden');
                }

                return isValid;
            }

            function showLogin() {
                loginSection.classList.remove('hidden');
                profileSection.classList.add('hidden');
            }

            function showProfile() {
                loginSection.classList.add('hidden');
                // registerSection.classList.add('hidden');
                profileSection.classList.remove('hidden');
                updateProfileDisplay();
            }

            
            function updateProfileDisplay() {
                const userId = localStorage.getItem('userId');

                if (!userId) {
                    console.error('User ID not found in localStorage.');
                    showToast('Please log in first.');
                    return;
                }

                fetch(`/api/user?id=${encodeURIComponent(userId)}`)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('Failed to fetch user data');
                        }
                        return res.json();
                    })
                    .then(userData => {
                        document.getElementById('profile-name').textContent = userData.name;
                        document.getElementById('profile-email').textContent = userData.email;
                        document.getElementById('profile-contact').textContent = userData.contact;
                        document.getElementById('profile-city').textContent = userData.city;
                        document.getElementById('profile-province').textContent = userData.province;
                        document.getElementById('profile-region').textContent = userData.region;
                    })
                    .catch(err => {
                        console.error('Error fetching user data:', err);
                        showToast('Failed to load profile. Please try again.');
                    });
            }

            // Show edit form
            function showEditForm() {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('No user logged in.');
                    return;
                }

                fetch(`/api/user?id=${encodeURIComponent(userId)}`)
                    .then(res => {
                        if (!res.ok) throw new Error('Failed to load user data');
                        return res.json();
                    })
                    .then(userData => {
                        document.getElementById('edit-name').value = userData.name || '';
                        document.getElementById('edit-email').value = userData.email || '';
                        document.getElementById('edit-contact').value = userData.contact || '';
                        document.getElementById('edit-city').value = userData.city || '';
                        document.getElementById('edit-province').value = userData.province || '';
                        document.getElementById('edit-region').value = userData.region || '';

                        profileView.classList.add('hidden');
                        profileEdit.classList.remove('hidden');
                    })
                    .catch(err => {
                        showToast('Error loading profile: ' + err.message);
                    });
            }


            function hideEditForm() {
                profileView.classList.remove('hidden');
                profileEdit.classList.add('hidden');
                document.getElementById('save-error').classList.add('hidden');
            }

            function showToast(message) {
                const toast = document.getElementById('success-toast');
                const toastMessage = document.getElementById('toast-message');
                
                toastMessage.textContent = message;
                toast.classList.remove('translate-x-full');
                
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                }, 3000);
            }
        });
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
<script id="dhws-elementInspector" src="../public/dhws-web-inspector.js"></script>
<script id="dhws-errorTracker" src="../public/dhws-error-tracker.js"></script>
</body>
</html>